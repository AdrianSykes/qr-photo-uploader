<!DOCTYPE html>
<html>
<head>
  <title>QR Photo Upload</title>
</head>
<body>
  <h2>Upload a Photo ({{ count }}/100)</h2>

  <video id="video" autoplay playsinline width="300"></video><br>
  <button onclick="switchCamera()">Switch Camera</button>
  <button onclick="capturePhoto()">Capture Photo</button>
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    let currentFacingMode = "environment";
    let stream;

    async function startCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode }
        });
        document.getElementById('video').srcObject = stream;
      } catch (err) {
        alert("Camera access failed: " + err);
      }
    }

    function switchCamera() {
      currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
      startCamera();
    }

    function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      canvas.toBlob(blob => {
        const formData = new FormData();
        formData.append('photo', blob, 'photo.jpg');
        fetch('/upload', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => alert(data.message))
        .catch(err => alert("Upload failed: " + err));
      }, 'image/jpeg');
    }

    startCamera();
  </script>
</body>
</html>


